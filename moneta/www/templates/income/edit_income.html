{% extends "base.html" %}
{% load static %}
{% block content %}
<head>
  <link rel="stylesheet" href="{% static 'css/detailed_page.css' %}" type="text/css">
 <script>
function deleteWindow(){
    $('#deleteIncomeWindow').css("display","flex");
};

  function cancelDelete(){
     document.querySelector('#deleteIncomeWindow').style.display = 'none';
};

function addTransactions(json){   
 console.log("is", json);  
 var htmlTransactions = "<hr>";
  var income_keys = Object.keys(json);
  for (i=0;i<income_keys.length;i++)
    {      
      var transactionDate = new Date(json[i].create_time * 1000);
      let dateFormatted = transactionDate.getDate() + "." + (transactionDate.getMonth() + 1) + "." + transactionDate.getFullYear()
  dateStr = dateFormatted.toLocaleString();
    htmlTransactions += ` 
    ${json[i].name_from}  &#8594; ${json[i].name_to} <span class="text-secondary">  ${json[i].amount_change} </span> ${dateStr}`;
    if (i==0){
   htmlTransactions += `<button style="width: 5%; background-color:#F7F7F7; color:#dc3545; display:inline-block;margin-bottom: 6px;margin-left: 5px;" type="cancel" id="deleteTransaction" class="btn btn-outline-danger"> 
    <i class="fas fa-times"></i> </button>`}
   htmlTransactions += ` <hr> `;
    }
 return htmlTransactions;
}



$(function() {
    let income_id = window.location.href.split('/')[4];
$.when(
    $.getJSON(window.location.origin + `/api/v1/income/${income_id}/transaction/get`)
).done( function(json) {
  console.log(json);
  //console.log(Object.keys(json));
/*  var income_keys = Object.keys(json);
  for (i=0;i<income_keys.length;i++)
    { console.log(json[i].name_from);
    } */
  htmlStr = addTransactions(json);
  $("#transactionList").html(htmlStr);

  })
 
  });




function deleteIncome(){
 $.ajax(
        {
            type:"DELETE",
            url: window.location.href + "delete/",
            success:function (response) {
                console.info(response);
                 document.querySelector('#deleteIncomeWindow').style.display = 'none';
                 location.href = "{% url 'moneta-home' %}";
            },
            error(error){
                console.error(error);
            }
        })
};
</script> 
<title> Income </title>
</head>

    <body>
  <div class="row">
    <!-- DETAIL BEGIN -->
    <div class="col-md-5 col-sm-12">
      <h3 class="current-header">Detailed information about income</h3>
      <div class="detail-container">
        <div class="row">
          <div class="col-4">
            <span class=" detail-page-icon {{ income_info.css }}" id="detail-current-css"></span>
          </div>
          <div class="col-8">
            <div class="row">
              <div class="col-md-4 col-sm-12">
                <span class="text-secondary">Name:</span>
              </div>
              <div class="col-md-8 col-sm-12">
                <strong>
                  <span id="detail-current-name">{{ income_info.name }}</span>
                </strong>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-4 col-sm-12">
                <span class="text-secondary">Currency:</span>
              </div>
              <div class="col-md-8 col-sm-12">
                <strong>
                  <span id="detail-current-amount">{{ income_info.currency }}</span>                  
                </strong>
              </div>
            </div>
            <hr>
            <button onclick="deleteWindow()">Delete income </button>
            <button id="editIncome" name="edit">Edit income</button>
          </div>
        </div>
      </div>
    </div>
    <!-- DETAIL END -->
    <!-- TRANSACTIONS BEGIN -->
    <div class="col-md-7 col-sm-12">
      <h3 class="current-header">History of transactions</h3>
      <div class="detail-container">
        <div id="transactionList">
        
        <div>

      </div>
    </div>
  </div>
    <!-- TRANSACTIONS END -->
  <div class = "bg-modal-detailed-page" id="deleteIncomeWindow">       
  <div class="container-input container-width-350"  >
    <h1>Do you really want to delete this Income?</h1>
      <div class="row justify-content-center">
        <div class="col-md-3">
          <span class="text-secondary">Name:</span>
        </div>
        <div class="col-md-6">
          <strong>
            <span id="detail-current-name">{{ income_info.name }}</span>
          </strong>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-3">
          <span class="text-secondary">Currency:</span>
        </div>
        <div class="col-md-6">
          <strong>
            <span id="detail-current-name">{{ income_info.currency }}</span>
          </strong>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-3">
          <span class="text-secondary">Icon:</span>
        </div>
        <div class="col-md-6">
          <span class="{{ income_info.css }} icon-on-delete"></span>
        </div>
      </div>
      <br>
      <button onclick="deleteIncome()">Yes, delete</button>
      <button onclick="cancelDelete()">Cancel</button>
  </div>
</div>
</body>
{% endblock content %}
