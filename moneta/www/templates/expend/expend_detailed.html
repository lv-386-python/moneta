{% extends "base.html" %}
{% load static %}

{% block title %}Expends{% endblock %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/detailed_page.css' %}" type="text/css">
   <script src={% static "js/transactions.js" %}></script>
  <script>
$(function() {
    let expend_id = window.location.href.split('/')[4];
$.when(
    $.getJSON(window.location.origin + `/api/v1/expend/${expend_id}/transaction/get`)
).done( function(json) {
  console.log(json);
    var json_keys = Object.keys(json);
  if (json_keys.length < 1){ 
    htmlCode = emptyJson();
    formedTable = makeEmptyTable(htmlCode);
   }
else { 
  htmlCode = showTransactions(json);
    formedTable = makeTable(htmlCode);
  }
  })
  });
$(function() {
    get_share_list();});
</script>

  <div class="row">

    <!-- DETAIL BEGIN -->

    <div class="col-md-5 col-sm-12">
      <h3 class="current-header">Detailed information about expend</h3>

      <div class="detail-container">

        <div class="row">
          <div class="col-4">
            <span class=" detail-page-icon {{ expend_detailed.image_id }}" id="detail-current-css"></span>
          </div>

          <div class="col-8">


            <div class="row">
              <div class="col-md-4 col-sm-12">
                <span class="text-secondary">Name:</span>
              </div>
              <div class="col-md-8 col-sm-12">
                <strong>
                  <span id="detail-current-name">{{ expend_detailed.name }}</span>
                </strong>
              </div>
            </div>

            <hr>
            <div class="row">
              <div class="col-md-4 col-sm-12">
                <span class="text-secondary">Amount:</span>
              </div>
              <div class="col-md-8 col-sm-12">
                <strong>
                  <span id="detail-current-amount">{{ expend_detailed.amount }}</span>
                  {{ expend_detailed.currency }}
                </strong>
              </div>
            </div>

            <hr>

            <form id="popup-delete">
              <button value="delete">Delete expend</button>
            </form>
            {% if expend_detailed.can_edit == 1 %}
              {#            <form id="popup-edit">#}
              {#              <button value="edit">Edit current</button>#}
              {#            </form>#}
              <button id="editExpend" name="edit">Edit expend</button>
            {% endif %}

          </div>

        </div>

      </div>

      <!-- SHARING BEGIN -->
      {% if expend_detailed.owner_id == expend_detailed.user_id %}
        <h3 class="current-header">Sharing</h3>

        <div class="detail-container">

          <div class="row">

            <form id="share"> {% csrf_token %}

              Email: <input type="text" name="email">
              Can edit: <input type="checkbox" name="can_edit">
              <input type='button' class="share_button" value="Share" onclick="share()">
              <div id="Log_div"></div>
              <div id="Error_div"></div>
            </form>

            <div class="col-11" id="ShareContainer">

            </div>

          </div>
        </div>
      {% endif %}
      <!-- SHARING END -->

    </div>

    <!-- DETAIL END -->

    <!-- TRANSACTIONS BEGIN -->
    <div class="col-md-7 col-sm-12">
      <h3 class="current-header">History of transactions</h3>
      <div class="detail-container" style="">
        <table id="transactionTable" class="display" cellspacing="0" width="100%">
        
        </table>

      </div>
    </div>
  </div>
    <!-- TRANSACTIONS END -->

  {# MODAL WINDOW FOR EXPEND DELETE #}
  <div class="bg-modal-detailed-page" id="current-delete-container">
  </div>

  {# MODAL WINDOW FOR EXPEND EDIT #}
  <div class="bg-modal-detailed-page" id="current-edit-container">
  </div>

  {# MODAL WINDOW FOR EXPEND SHARE #}
  <div class="bg-modal-detailed-page" id="current-share-container">
  </div>

  <script type="text/javascript">
    function share() {
      let inputs = {};
      let expend_id = window.location.href.split('/')[4];
      let url_text = window.location.origin + '/api/v1/expend/' + expend_id + '/share';
      $("#share").serializeArray().forEach(function (element) {
        inputs[element.name] = element.value;
      });
      $.ajax({
        type: 'POST',
        url: url_text,
        data: inputs,
        success: function (response) {
          console.log(response);
          document.getElementById("Log_div").innerHTML = response;
          document.getElementById("Error_div").innerHTML = '';
          get_share_list();
        },
        error: function (error) {
          document.getElementById("Log_div").innerHTML = '';
          document.getElementById("Error_div").innerHTML = error.responseText;
          console.log(error);
        },
      });
    }

    function unshare(id) {
      let expend_id = window.location.href.split('/')[4];
      let url_text = window.location.origin + '/api/v1/expend/' + expend_id + '/unshare/' + id;
      console.log(url_text);
      $.ajax(
        {
          type: "DELETE",
          url: url_text,
          data: {},
          success: function (response) {
            console.log(response);
            document.getElementById("Log_div").innerHTML = response;
            document.getElementById("Error_div").innerHTML = '';
            get_share_list();
          },
          error(response) {
            console.error(error);
            document.getElementById("Log_div").innerHTML = '';
            document.getElementById("Error_div").innerHTML = error.responseText;
          }
        })
    }

    function get_share_list() {
      let expend_id = window.location.href.split('/')[4];
      $.when(
          $.getJSON(window.location.origin + `/api/v1/expend/${expend_id}/share/get`)
      ).done( function(json) {
      var json_keys = Object.keys(json);
      if (json_keys.length < 1){
          console.log('None');
          share_list = {};
          document.getElementById("ShareContainer").innerHTML = '';
      }
      else {
          console.log(json)
          var sting_to_add = '';
          for(i=0;i<json_keys.length;i++){
            sting_to_add += '<form id="unshare_form", class="share_list">\
                             ' + json[i].email + '\
                             <button id="Unshare_button", type="button", \
                             onclick="unshare(' + json[i].user_id + ')"> <i class="fas fa-times"></i> </button>\
                             </form>\
                             <hr>'

          document.getElementById("ShareContainer").innerHTML = sting_to_add;
          }
      }
      })
      }


    $(document).on('submit','#popup-delete',function (e) {
        e.preventDefault();
        document.querySelector('.bg-modal-detailed-page').style.display = 'flex';

    });
    $(document).on('submit','#cancel-delete', function (e) {
        e.preventDefault();
        document.querySelector('.bg-modal-detailed-page').style.display = 'none';


    });
    $(document).on('submit','#submit-delete', function (e) {
    e.preventDefault();

    $.ajax({
        type:'DELETE',
        url : '',
        data:{
            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(response){
            $('.modal-content').html(
            `
            <img src="{% static 'images/current/notes.svg' %}" alt="">
            <h2 id="expend_deleted">This expand was deleted</h2>
             <p id="link_to_expends">
                 <a href="/" >Go to main page</a>
             </p>`
             )

        },
        error : function (error) {
            console.error(error);
            alert('oooops...')
        },
    });
});

    // POP UP WINDOW FOR SHARE EXPEND
    $(document).on('submit', '#popup-share', function (e) {
      e.preventDefault();
      $.ajax(
        {
          type: "GET",
          datatype: "html",
          url: window.location.href + "share/",
          data: {
          },
          success: function (response) {
            $('#expend-share-container').html(response);
          },
          error(error) {
            console.error(error);
          }
        });
      document.querySelector('#expend-share-container').style.display = 'flex';
    });



</script>

{% endblock content %}
